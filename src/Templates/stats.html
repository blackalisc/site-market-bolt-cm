{% extends "layout.html" %}

{% block ga_extras %}
    ga('set', 'page', '/stats/<package-uuid>');
    ga('set', 'dimension2', '{{package.id}}');
    ga('set', 'dimension3', '{{package.title}}');
{% endblock %}

{% block content %}

<style>
	.package-statistics {
		margin-top: 40px;
	}

	.package-statistics .legend .line-legend {
		list-style-type: none;
	}

	.package-statistics .legend .line-legend li{
		display: inline;
		margin-right: 20px;
	}

	.package-statistics .legend .line-legend span {
		width: 10px;
		height: 10px;
		display: inline-block;
		margin-right: 10px;
	}
</style>

<div class="ui grid stackable">
	<div class="twelve wide column">
        <h2 class="ui header">
            <img class="ui rounded image" src="{{packageIcon(package)}}">
            <div class="content">
                {{package.title}}
                <div class="sub header">Statistics (beta)</div>
            </div>
        </h2>
        <!-- <div>Last Update: 13/08/2015</div> -->
    </div>
</div>
<template id="chart-template">
	<div class="package-statistics">

		<div class="ui grid stackable">
	        <div class="eight wide column">
				<h2>Downloads</h2>
			</div>
			<div class="right floated right aligned eight wide column">

				Group by:
				<select v-model="group">
					<option value="months">Months</option>
					<option value="days">Days</option>
				</select> <br>

				Version:
				<select v-model="version">
					<option v-for="v in versions" :value="v">
						{% raw %}
						   {{ v ? v : 'All Versions' }}
						{% endraw %}
					</option>
				</select> <br>

				From:
				<select v-model="from.year">
					<option v-for='number in ["2013","2014","2015","2016"]' :value="number">
						{% raw %}
						   {{ number }}
						{% endraw %}
					</option>
				</select>
				<select v-model="from.month">
					<option v-for='number in ["01","02","03","04","05","06","07","08","09","10","11","12"]' :value="number">
						{% raw %}
						   {{ number }}
						{% endraw %}
					</option>
				</select>
				<select v-model="from.day" v-show="group == 'days'">
					<option v-for='number in ["01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31"]' :value="number">
						{% raw %}
						   {{ number }}
						{% endraw %}
					</option>
				</select> <br>

				To:
				<select v-model="to.year">
					<option v-for='number in ["2013","2014","2015","2016"]' :value="number">
						{% raw %}
						   {{ number }}
						{% endraw %}
					</option>
				</select>
				<select v-model="to.month">
					<option v-for='number in ["01","02","03","04","05","06","07","08","09","10","11","12"]' :value="number">
						{% raw %}
						   {{ number }}
						{% endraw %}
					</option>
				</select>
				<select v-model="to.day" v-show="group == 'days'">
					<option v-for='number in ["01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31"]' :value="number">
						{% raw %}
						   {{ number }}
						{% endraw %}
					</option>
				</select> <br>

				<button @click="refresh()">Update</button>
			</div>
		</div>

		<div class="loading" v-show="loading">
			loading data ...
		</div>

		<canvas v-el:canvas></canvas>
		<div class="legend">
			{% raw %}
			   {{{ legend }}}
			{% endraw %}
		</div>
	</div>
</template>

{% endblock %}

{% block footer_extra_scripts %}
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.20/vue.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vue-resource/0.7.0/vue-resource.min.js"></script>
	<script>
		var packageID = "{{ package.id }}";
		new Vue({
		  el: '#chart-template',
		  data: {
		  	title: '',
		  	labels: [],
		  	datasets: [],
		  	versions: [''],
		  	chart: null,
		  	legend: '',
		  	loading: true,
		  	group: 'months',
		  	from: {
		  		year: '2015',
		  		month: '01',
		  		day: '01'
		  	},
		  	to: {
		  		year: '2016',
		  		month: '05',
		  		day: '01'
		  	},
		  	version: ''

		  },

		  ready: function(){
		  	var today = new Date();

		  	this.from.year = today.getFullYear() - 1;
		  	this.from.month = this.str_pad(today.getMonth()+1);
		  	this.from.day = this.str_pad(today.getDate());

		  	this.to.year = today.getFullYear();
		  	this.to.month = this.str_pad(today.getMonth()+1);
		  	this.to.day = this.str_pad(today.getDate());

		  	this.loadData();
		  },

		  methods: {

		  	refresh: function(){
		  		var _MS_PER_DAY = 1000 * 60 * 60 * 24;
		  		var date1 = new Date(this.from.month + '/' + this.from.day + '/' + this.from.year);
				var date2 = new Date(this.to.month + '/' + this.to.day + '/' + this.to.year);
				var utc1 = Date.UTC(date1.getFullYear(), date1.getMonth(), date1.getDate());
  				var utc2 = Date.UTC(date2.getFullYear(), date2.getMonth(), date2.getDate());
				var diff = Math.floor((utc2 - utc1) / _MS_PER_DAY);

				if(this.group === 'days' && diff > 31){
					alert('Please select a time range smaller than 31 days');
					return;
				}

		  		this.loading = true;
		  		this.chart.destroy();
		  		this.legend = '';
		  		this.loadData();
		  	},

		  	loadData: function(){

		  		var from = '';
		  		var to = '';

		  		if(this.group == 'months') {
		  			from = this.from.year + '-' + this.from.month;
		  			to = this.to.year + '-' + this.to.month;
		  		}else if(this.group == 'days') {
		  			from = this.from.year + '-' + this.from.month + '-' + this.from.day;
		  			to = this.to.year + '-' + this.to.month + '-' + this.to.day;
		  		}

		  		this.$http.get('/api/stats/' + packageID + '?group=' + this.group + '&from=' + from + '&to=' + to + '&version=' + this.version, [], []).then(function (response) {
		  			this.title = response.data.title;
		         	this.labels = response.data.labels;
		         	this.datasets = response.data.datasets;
		         	this.versions = response.data.allVersions;

		         	this.versions.unshift('');

		         	this.loading = false;
		         	this.makeChart();
		      }, function (response) {
		          // error callback
		      });
		  	},

		  	makeChart: function(){

		  		Chart.defaults.global.multiTooltipTemplate = "<%= value %> (<%=datasetLabel%>)";

			  	this.chart = new Chart(
				    this.$els.canvas.getContext('2d')
				).Line({
					labels: this.labels,
					datasets: this.datasets
				},{
				    maintainAspectRatio: true,
				    responsive: true
				});

				this.legend = this.chart.generateLegend();
		  	},

		  	str_pad: function(n) {
			    return String("00" + n).slice(-2);
			}
		  }
		});
	</script>
{% endblock %}
